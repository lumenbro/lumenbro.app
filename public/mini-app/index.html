<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LumenBro Mini App</title>
    <link rel="stylesheet" href="/mini-app/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/turnkey.js?v=2"></script> <!-- Updated to esbuild output with cache busting -->
    <!-- Stellar SDK bundle - local deployment for reliability -->
    <script src="/stellar.js?v=1"></script>
    <script>
        // Debug: Check what's available
        console.log('üîç Checking available packages...');
        console.log('Available globals:', Object.keys(window).filter(key => key.toLowerCase().includes('stellar')));
        console.log('üîç Stellar SDK loaded:', typeof StellarSdk !== 'undefined' ? 'Yes' : 'No');
    </script>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body>
    <div id="content" class="fade-in">
        <!-- Wallet-First Interface -->
        <div id="wallet-interface" style="display: none;">
            <h1>LumenBro Wallet</h1>
            <div class="wallet-balance">
                <div class="balance-card">
                    <h3>üí∞ Balance</h3>
                    <div class="balance-amount">Loading...</div>
                    <div class="balance-currency">XLM</div>
                </div>
            </div>

            <div class="wallet-actions">
                <button onclick="showSendPayment()" class="btn-primary">üí∏ Send Payment</button>    
                <button onclick="showAssetManagement()" class="btn-success">üîÑ Manage Assets</button>
                <button onclick="showTransactionHistory()" class="btn-info">üìä History</button>     
            </div>

            <div class="wallet-status">
                <div id="connection-status" class="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </div>

        <!-- Auth Interface (Fallback) -->
        <div id="auth-interface">
        <h1>Welcome to LumenBro Trading Bot</h1>
            <div class="flex flex-col items-center gap-4">
                <button onclick="window.register()" class="btn-primary">üìù Register</button>        
                <button onclick="window.login()" class="btn-success">üîê Login</button>
                <button onclick="window.recover()" class="btn-warning">üîë Recover</button>
                <button onclick="window.location.href='/test-near-compatibility'" class="btn-secondary">üîó NEAR Test</button>
            </div>

            <!-- Quick access to wallet (if authenticated) -->
            <div id="quick-wallet-access" style="display: none; margin-top: 20px;">
                <button onclick="showWallet()" class="btn-info">üíº Open Wallet</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" style="display: none;">
            <div class="nav-item active" onclick="showWallet()">
                <div class="nav-icon">üíº</div>
                <div class="nav-label">Wallet</div>
            </div>
            <div class="nav-item" onclick="showAuth()">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Settings</div>
            </div>
        </nav>
    </div>
    <script src="/recovery-credentials.js"></script>
    <script src="/mini-app/encryption-utils.js"></script>
    <script src="/mini-app/recovery-key-generator.js"></script>
    <script src="/mini-app/export-utils.js"></script>
    <script src="/mini-app/auth.js"></script>
    <script src="/mini-app/login.js"></script>
    <script src="/mini-app/recovery.js"></script>
    <script src="/mini-app/clear.js"></script>  <!-- New script for clear -->
    <script src="/mini-app/mobile-debug.js"></script>  <!-- Mobile debugging -->
    <script src="/mini-app/mobile-encryption-fix.js"></script>  <!-- Mobile encryption fixes -->
    <script src="/mini-app/transaction-stamper.js"></script>  <!-- Transaction signing stamper -->
    
    <!-- Load modular components -->
    <script src="/mini-app/js/utils.js"></script>
    <script src="/mini-app/js/wallet-core.js"></script>
    <script src="/mini-app/js/swap-engine.js"></script>
    <script src="/mini-app/js/ui-manager.js"></script>
    <script src="/mini-app/js/transaction-manager.js"></script>
    <style>
        .status {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .status.success {
            background: rgba(57, 217, 138, 0.1);
            color: var(--success);
            border-color: rgba(57, 217, 138, 0.3);
        }
        .status.error {
            background: rgba(255, 107, 107, 0.1);
            color: var(--danger);
            border-color: rgba(255, 107, 107, 0.3);
        }
        .status.loading {
            background: rgba(79, 138, 255, 0.1);
            color: var(--primary);
            border-color: rgba(79, 138, 255, 0.3);
        }
    </style>
    <script>
        window.addEventListener('load', function () {  // Wait for all resources (including bundle)
            console.log('All loaded ‚Äì checking Turnkey...');
            if (!window.Turnkey) {
                console.error('Turnkey global not set after load. Check bundle content for errors.');
            } else {
                console.log('Turnkey ready:', window.Turnkey);
            }
            const telegramApp = window.Telegram.WebApp;
            window.params = new URLSearchParams(window.location.search);
            window.orgId = window.params.get('orgId') || 'global-org-id';  // Set global orgId from query param
            window.email = window.params.get('email') || '';  // Set global email from query param
            const action = window.params.get('action');
            if (action === 'register') {
                window.register();
            } else if (action === 'login') {
                window.login();
            } else if (action === 'recover') {
                window.recover();
            } else if (action === 'export') {
                // Ensure orgId/email are available to the export form
                window.orgId = window.params.get('orgId') || window.orgId || '';
                window.email = window.params.get('email') || window.email || '';
                window.showExportForm();
            } else if (action === 'auto-clear') {
                window.autoClearCloudStorage();
            }

            // Debug function and button (made global)
            window.checkCloudStorage = async function() {
                return new Promise((resolve, reject) => {
                    Telegram.WebApp.CloudStorage.getItem('TURNKEY_API_KEY', (error, value) => {
                        if (error) {
                            console.error('Cloud storage error:', error);
                            reject(error);
                        } else {
                            console.log('Stored TURNKEY_API_KEY:', value ? JSON.parse(value) : 'No key stored');
                            resolve(value ? JSON.parse(value) : null);
                        }
                    });
                });
            }

            // Add debug buttons only for development/testing, not on sensitive pages
            const sensitiveActions = ['login', 'export', 'recover'];
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const showDebugButtons = isDevelopment && !sensitiveActions.includes(action);

            if (showDebugButtons) {
                document.getElementById('content').innerHTML += '<button onclick="window.checkCloudStorage()" class="btn-info">üîç Check Cloud Storage</button>';
                document.getElementById('content').innerHTML += '<button onclick="window.showClearWarning()" class="btn-danger">‚ö†Ô∏è Clear Data</button>';
            }

            // Only initialize wallet interface if no specific action is requested
            if (!action) {
                initializeWalletInterface();
            }
        });

        // Wallet interface functions
        function initializeWalletInterface() {
            console.log('Initializing wallet interface...');
            
            // Initialize modular components
            console.log('üîß Initializing modular components...');
            if (window.Utils) window.Utils.init();
            if (window.WalletCore) window.WalletCore.init();
            if (window.SwapEngine) window.SwapEngine.init();
            if (window.UIManager) window.UIManager.init();
            if (window.TransactionManager) window.TransactionManager.init();
            console.log('‚úÖ All modules initialized');

            // Check if user is authenticated
            checkUserAuthentication().then(isAuthenticated => {
                if (isAuthenticated) {
                    window.UIManager.showWallet();
                } else {
                    window.UIManager.showAuth();
                }
            });
        }

        async function checkUserAuthentication() {
            try {
                console.log('üîç Checking user authentication...');
                // Check if user has stored keys
                const storedKey = await window.checkCloudStorage();
                console.log('üîç Stored key result:', storedKey ? 'Found' : 'Not found');
                const isAuthenticated = !!storedKey;
                console.log('üîç Authentication result:', isAuthenticated);
                return isAuthenticated;
            } catch (error) {
                console.log('‚ùå User not authenticated:', error);
                return false;
            }
        }

        // showWallet moved to UIManager module

        // showAuth moved to UIManager module

        // loadWalletData moved to WalletCore module

        // updateConnectionStatus moved to UIManager module

        // displayAllAssets moved to WalletCore module

        // fetchAssetMetadata and fetchAssetFromToml moved to WalletCore module

        // showSendPayment moved to UIManager module

        async function checkSwapSessionStatus() {
            try {
                const response = await fetch('/mini-app/authenticator');
                const data = await response.json();
                
                console.log('üîç Swap session check response:', data);
                
                // Handle the proxy response structure from Node.js to Python bot
                if (data.success && data.authenticator_info?.authenticator?.has_active_session) {
                    console.log('‚úÖ Active database session detected:', {
                        type: data.authenticator_info.authenticator.type,
                        signingMethod: data.authenticator_info.authenticator.signing_method,
                        hasActiveSession: data.authenticator_info.authenticator.has_active_session
                    });
                    return {
                        hasActiveSession: true,
                        sessionType: data.authenticator_info.authenticator.type,
                        signingMethod: data.authenticator_info.authenticator.signing_method
                    };
                } else {
                    console.log('‚ùå No active database session:', {
                        success: data.success,
                        hasActiveSession: data.authenticator_info?.authenticator?.has_active_session,
                        type: data.authenticator_info?.authenticator?.type,
                        signingMethod: data.authenticator_info?.authenticator?.signing_method,
                        fullResponse: data
                    });
                    return {
                        hasActiveSession: false,
                        sessionType: null,
                        signingMethod: null
                    };
                }
            } catch (error) {
                console.error('Error checking swap session status:', error);
                return {
                    hasActiveSession: false,
                    sessionType: null,
                    signingMethod: null
                };
            }
        }

        async function showSwapInterface() {
            const sessionStatus = await checkSwapSessionStatus();
            
            document.getElementById('content').innerHTML = `
                <div class="fade-in">
                    <h1>üîÑ Swap Assets</h1>
                    
                    <div class="swap-mode-selection">
                        <h3>Choose Swap Mode:</h3>
                        <div class="swap-mode-options">
                            ${sessionStatus.hasActiveSession ? `
                                <div class="swap-mode-option active" onclick="selectSwapMode('instant')">
                                    <div class="mode-icon">‚ö°</div>
                                    <div class="mode-info">
                                        <div class="mode-title">Instant Swap</div>
                                        <div class="mode-description">Use your active session (${sessionStatus.sessionType})</div>
                                    </div>
                                    <div class="mode-status">‚úÖ Available</div>
                                </div>
                            ` : `
                                <div class="swap-mode-option disabled">
                                    <div class="mode-icon">‚ö°</div>
                                    <div class="mode-info">
                                        <div class="mode-title">Instant Swap</div>
                                        <div class="mode-description">Requires active session</div>
                                    </div>
                                    <div class="mode-status">‚ùå Not Available</div>
                                </div>
                            `}
                            
                            <div class="swap-mode-option ${!sessionStatus.hasActiveSession ? 'active' : ''}" onclick="selectSwapMode('password')">
                                <div class="mode-icon">üîê</div>
                                <div class="mode-info">
                                    <div class="mode-title">Password Swap</div>
                                    <div class="mode-description">Sign each swap with password</div>
                                </div>
                                <div class="mode-status">‚úÖ Always Available</div>
                            </div>
                        </div>
                    </div>

                    <div class="swap-form" style="display: none;">
                        <div class="form-group">
                            <label for="sendAssetSelect">Send Asset:</label>
                            <select id="sendAssetSelect" class="form-select" onchange="updateSwapEstimate()">
                                <option value="XLM">XLM (Native)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="sendAmount">Send Amount:</label>
                            <input type="number" id="sendAmount" class="form-control" placeholder="0.0000000" step="0.0000001" onchange="updateSwapEstimate()">
                        </div>
                        
                        <div class="swap-direction">
                            <div class="swap-arrow">‚Üì</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="receiveAssetSelect">Receive Asset:</label>
                            <select id="receiveAssetSelect" class="form-select" onchange="updateSwapEstimate()">
                                <option value="XLM">XLM (Native)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="receiveAmount">Receive Amount (Estimate):</label>
                            <input type="number" id="receiveAmount" class="form-control" placeholder="0.0000000" step="0.0000001" readonly>
                        </div>
                        
                        <div class="swap-details">
                            <div class="detail-row">
                                <span class="label">Network Fee:</span>
                                <span class="value" id="swapNetworkFee">0.00001 XLM</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Service Fee:</span>
                                <span class="value" id="swapServiceFee">0.00001 XLM</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Slippage:</span>
                                <span class="value" id="swapSlippage">0.5%</span>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button onclick="goBackToWallet()" class="btn-secondary">‚Üê Back</button>
                            <button onclick="executeSwap()" class="btn-primary">üîÑ Execute Swap</button>
                        </div>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item" onclick="showWallet()">
                        <div class="nav-icon">üíº</div>
                        <div class="nav-label">Wallet</div>
                    </div>
                    <div class="nav-item" onclick="showAuth()">
                        <div class="nav-icon">‚öôÔ∏è</div>
                        <div class="nav-label">Settings</div>
                    </div>
                </nav>
            `;
            
            // Populate asset selects
                            await window.WalletCore.populateSwapAssetSelects();
        }

        function selectSwapMode(mode) {
            const swapForm = document.querySelector('.swap-form');
            const modeOptions = document.querySelectorAll('.swap-mode-option');
            
            // Update active states
            modeOptions.forEach(option => {
                option.classList.remove('active');
            });
            
            // Find and activate the selected mode
            const selectedOption = Array.from(modeOptions).find(option => 
                option.querySelector('.mode-title').textContent.toLowerCase().includes(mode)
            );
            if (selectedOption && !selectedOption.classList.contains('disabled')) {
                selectedOption.classList.add('active');
            }
            
            // Show swap form
            swapForm.style.display = 'block';
            
            // Store the selected mode
            window.selectedSwapMode = mode;
            
            console.log(`Selected swap mode: ${mode}`);
        }

        async function executeSwap() {
            const sendAssetSelect = document.getElementById('sendAssetSelect');
            const receiveAssetSelect = document.getElementById('receiveAssetSelect');
            const sendAmount = document.getElementById('sendAmount').value;
            
            if (!sendAmount || parseFloat(sendAmount) <= 0) {
                alert('Please enter a valid send amount');
                return;
            }
            
            // Parse asset information
            let sendAsset, receiveAsset;
            if (sendAssetSelect.value === 'XLM') {
                sendAsset = 'XLM';
            } else {
                try {
                    sendAsset = JSON.parse(sendAssetSelect.value);
                } catch (error) {
                    alert('Invalid send asset selection');
                    return;
                }
            }
            
            if (receiveAssetSelect.value === 'XLM') {
                receiveAsset = 'XLM';
            } else {
                try {
                    receiveAsset = JSON.parse(receiveAssetSelect.value);
                } catch (error) {
                    alert('Invalid receive asset selection');
                    return;
                }
            }
            
            if (sendAsset === receiveAsset) {
                alert('Send and receive assets must be different');
                return;
            }
            
            console.log('üîÑ Starting swap execution...');
            console.log('Send Asset:', sendAsset);
            console.log('Receive Asset:', receiveAsset);
            console.log('Send Amount:', sendAmount);
            console.log('Swap Mode:', window.selectedSwapMode);
            
            // TODO: Phase 2 - Implement quote fetching
            // TODO: Phase 3 - Implement transaction building
            // TODO: Phase 4 - Implement execution
            
            alert('Swap functionality coming soon! This will be implemented in the next phase.');
        }

        // populateAssetSelect moved to WalletCore module

        // populateSwapAssetSelects moved to WalletCore module

        async function updateSwapEstimate() {
            const sendAssetValue = document.getElementById('sendAssetSelect')?.value;
            const sendAmount = parseFloat(document.getElementById('sendAmount')?.value || 0);
            const receiveAssetValue = document.getElementById('receiveAssetSelect')?.value;

            if (!sendAssetValue || !sendAmount || !receiveAssetValue || sendAssetValue === receiveAssetValue) {
                document.getElementById('swapRate').textContent = 'Select different assets';
                document.getElementById('receiveAmount').value = '';
                return;
            }

            // Parse asset information
            let sendAsset, receiveAsset;
            try {
                sendAsset = sendAssetValue === 'XLM' ? 'XLM' : JSON.parse(sendAssetValue);
                receiveAsset = receiveAssetValue === 'XLM' ? 'XLM' : JSON.parse(receiveAssetValue);
            } catch (error) {
                console.error('Failed to parse asset info:', error);
                document.getElementById('swapRate').textContent = 'Invalid asset selection';
                return;
            }

            try {
                // Get user's public key
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();
                const sourcePublicKey = authData.authenticator_info.user.public_key;

                // Simulate path payment
                const simulationResponse = await fetch('/mini-app/simulate-path-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sourcePublicKey: sourcePublicKey,
                        sendAsset: sendAsset,
                        sendAmount: sendAmount,
                        destination: sourcePublicKey, // Swap to self
                        destAsset: receiveAsset,
                        destMin: '0.0000001',
                        path: [],
                        telegram_id: authData.authenticator_info.user.telegram_id
                    })
                });

                if (simulationResponse.ok) {
                    const result = await simulationResponse.json();
                    
                    if (result.simulation.success) {
                        const minReceived = parseFloat(result.simulation.minReceived);
                        const rate = minReceived / sendAmount;
                        const sendAssetCode = typeof sendAsset === 'string' ? sendAsset : sendAsset.code;
                        const receiveAssetCode = typeof receiveAsset === 'string' ? receiveAsset : receiveAsset.code;
                        
                        document.getElementById('swapRate').textContent = `1 ${sendAssetCode} = ${rate.toFixed(6)} ${receiveAssetCode}`;
                        document.getElementById('receiveAmount').value = minReceived.toFixed(7);
                        document.getElementById('swapNetworkFee').textContent = `${result.fees.networkFee} XLM`;
                        document.getElementById('swapServiceFee').textContent = `${result.fees.serviceFee} XLM`;
                    } else {
                        document.getElementById('swapRate').textContent = 'No path found';
                        document.getElementById('receiveAmount').value = '';
                    }
                } else {
                    document.getElementById('swapRate').textContent = 'Simulation failed';
                    document.getElementById('receiveAmount').value = '';
                }
            } catch (error) {
                console.error('Swap estimation failed:', error);
                document.getElementById('swapRate').textContent = 'Error calculating';
                document.getElementById('receiveAmount').value = '';
            }
        }

        async function simulateAndExecuteSwap() {
            const sendAsset = document.getElementById('sendAssetSelect')?.value;
            const sendAmount = parseFloat(document.getElementById('sendAmount')?.value || 0);
            const receiveAsset = document.getElementById('receiveAssetSelect')?.value;
            const receiveAmount = parseFloat(document.getElementById('receiveAmount')?.value || 0);

            if (!sendAsset || !sendAmount || !receiveAsset || !receiveAmount || sendAsset === receiveAsset) {
                alert('Please fill in all swap details');
                return;
            }

            try {
                // Show loading state
                const swapButton = document.querySelector('.btn-primary');
                const originalText = swapButton.textContent;
                swapButton.textContent = '‚è≥ Simulating Swap...';
                swapButton.disabled = true;

                // Get user's public key
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();
                const sourcePublicKey = authData.authenticator_info.user.public_key;

                // Build path payment transaction
                const transactionBuilder = createStellarTransactionBuilder();
                await transactionBuilder.initialize();

                const transactionResult = await transactionBuilder.buildPathPaymentTransaction(
                    sourcePublicKey,
                    sendAsset === 'XLM' ? 'XLM' : { code: sendAsset, issuer: 'ISSUER' },
                    sendAmount,
                    sourcePublicKey, // Swap to self
                    receiveAsset === 'XLM' ? 'XLM' : { code: receiveAsset, issuer: 'ISSUER' },
                    receiveAmount,
                    []
                );

                // Store transaction data for signing
                window.currentSwapData = {
                    xdr: transactionResult.xdr,
                    sendAsset: sendAsset,
                    sendAmount: sendAmount,
                    receiveAsset: receiveAsset,
                    receiveAmount: receiveAmount,
                    source: transactionResult.source
                };

                // Show swap confirmation
                showSwapConfirmation();

            } catch (error) {
                console.error('Swap execution failed:', error);
                alert(`Swap failed: ${error.message}`);

                // Reset button
                const swapButton = document.querySelector('.btn-primary');
                swapButton.textContent = 'üîÑ Execute Swap';
                swapButton.disabled = false;
            }
        }

        function showSwapConfirmation() {
            const swapData = window.currentSwapData;
            
            document.getElementById('content').innerHTML = `
                <div class="fade-in">
                    <h1>üîç Confirm Swap</h1>

                    <div class="swap-confirmation">
                        <div class="swap-details">
                            <div class="swap-row">
                                <span class="label">You Send:</span>
                                <span class="value">${swapData.sendAmount} ${swapData.sendAsset}</span>
                            </div>
                            <div class="swap-row">
                                <span class="label">You Receive:</span>
                                <span class="value">${swapData.receiveAmount} ${swapData.receiveAsset}</span>
                            </div>
                            <div class="swap-row">
                                <span class="label">Rate:</span>
                                <span class="value">1 ${swapData.sendAsset} = ${(swapData.receiveAmount / swapData.sendAmount).toFixed(6)} ${swapData.receiveAsset}</span>
                            </div>
                            <div class="swap-row">
                                <span class="label">Transaction Source:</span>
                                <span class="value">${swapData.source}</span>
                            </div>
                        </div>

                        <div class="form-actions" style="margin-bottom: 100px;">
                            <button onclick="goBackToSwap()" class="btn-secondary">‚Üê Back</button>
                            <button onclick="signAndExecuteSwap()" class="btn-primary">‚úÖ Confirm & Execute</button>
                        </div>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item" onclick="showWallet()">
                        <div class="nav-icon">üíº</div>
                        <div class="nav-label">Wallet</div>
                    </div>
                    <div class="nav-item" onclick="showAuth()">
                        <div class="nav-icon">‚öôÔ∏è</div>
                        <div class="nav-label">Settings</div>
                    </div>
                </nav>
            `;
        }

        function goBackToSwap() {
            showSwapInterface();
        }

        async function signAndExecuteSwap() {
            try {
                // Show loading state
                const confirmButton = document.querySelector('.btn-primary');
                const originalText = confirmButton.textContent;
                confirmButton.textContent = '‚è≥ Executing Swap...';
                confirmButton.disabled = true;

                const swapData = window.currentSwapData;
                if (!swapData) {
                    throw new Error('No swap data found');
                }

                // Sign the transaction using session-based signing (no password required)
                const signedResult = await signTransactionWithSession(swapData.xdr, 'swap');

                if (!signedResult.success) {
                    throw new Error(signedResult.error || 'Swap signing failed');
                }

                // Submit the signed transaction to the network
                const submitResult = await submitTransactionToNetwork(signedResult.signed_xdr);

                if (!submitResult.success) {
                    throw new Error(submitResult.error || 'Swap submission failed');
                }

                // Show success message
                showSwapSuccess(submitResult.hash);

            } catch (error) {
                console.error('Swap execution failed:', error);
                alert(`Swap failed: ${error.message}`);

                // Reset button
                const confirmButton = document.querySelector('.btn-primary');
                confirmButton.textContent = '‚úÖ Confirm & Execute';
                confirmButton.disabled = false;
            }
        }

        function showSwapSuccess(hash) {
            document.getElementById('content').innerHTML = `
                <div class="fade-in">
                    <div class="success-message">
                        <div class="success-icon">‚úÖ</div>
                        <h1>Swap Successful!</h1>
                        <p>Your asset swap has been executed successfully.</p>
                        <div class="transaction-hash">
                            <strong>Transaction Hash:</strong><br>
                            <code style="word-break: break-all; font-size: 0.9em; line-height: 1.4; max-width: 100%; overflow-wrap: break-word;">${hash}</code>
                        </div>
                        <div class="form-actions" style="margin-top: 20px;">
                            <button onclick="showWallet()" class="btn-primary">üè† Back to Wallet</button>
                            <button onclick="window.open('https://stellar.expert/explorer/public/tx/${hash}', '_blank')" class="btn-secondary">üîç View on Explorer</button>
                        </div>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item" onclick="showWallet()">
                        <div class="nav-icon">üíº</div>
                        <div class="nav-label">Wallet</div>
                    </div>
                    <div class="nav-item" onclick="showAuth()">
                        <div class="nav-icon">‚öôÔ∏è</div>
                        <div class="nav-label">Settings</div>
                    </div>
                </nav>
            `;
        }

        function goBackToWallet() {
            window.UIManager.showWallet();
        }

        async function updateFeeDisplay() {
            const assetSelect = document.getElementById('assetSelect');
            const feeAmountSpan = document.getElementById('feeAmount');
            const serviceFeeSpan = document.getElementById('serviceFee');
            const amountInput = document.getElementById('amount');
            
            if (!assetSelect || !feeAmountSpan || !serviceFeeSpan) return;
            
            const assetValue = assetSelect.value;
            const amount = parseFloat(amountInput?.value || 0);
            
            // Network fee is always in XLM
            feeAmountSpan.textContent = '0.00001 XLM';
            
            // Service fee calculation depends on selected asset
            if (assetValue === 'XLM') {
                const feeAmount = Math.max(0.00001, amount * 0.001);
                serviceFeeSpan.textContent = `${feeAmount.toFixed(5)} XLM`;
            } else {
                try {
                    const asset = JSON.parse(assetValue);
                    if (amount > 0) {
                        // Calculate XLM equivalent for non-XLM assets
                        const xlmEquivalent = await window.Utils.getXlmEquivalent(asset, amount);
                        const feeAmount = Math.max(0.00001, xlmEquivalent * 0.001);
                        serviceFeeSpan.textContent = `${feeAmount.toFixed(5)} XLM`;
                    } else {
                        serviceFeeSpan.textContent = '0.00001 XLM';
                    }
                } catch (error) {
                    console.error('Failed to calculate fee for non-XLM asset:', error);
                    serviceFeeSpan.textContent = '0.00001 XLM';
                }
            }
        }

        // getXlmEquivalent and calculateProperFees moved to Utils module

        async function buildAndSignTransaction() {
            try {
                const recipientAddress = document.getElementById('recipientAddress').value.trim();  
                const assetValue = document.getElementById('assetSelect').value;
                const amount = document.getElementById('amount').value;
                const memo = document.getElementById('memo').value.trim();

                // Parse asset information
                let asset;
                if (assetValue === 'XLM') {
                    asset = 'XLM';
                } else {
                    try {
                        asset = JSON.parse(assetValue);
                    } catch (error) {
                        console.error('Failed to parse asset info:', error);
                        alert('Invalid asset selection');
                        return;
                    }
                }

                // Validation
                if (!recipientAddress || !amount) {
                    alert('Please fill in recipient address and amount');
                    return;
                }

                if (!recipientAddress.startsWith('G')) {
                    alert('Invalid Stellar address. Must start with G');
                    return;
                }

                // Show loading state
                const sendButton = document.querySelector('.btn-primary');
                const originalText = sendButton.textContent;
                sendButton.textContent = '‚è≥ Building Transaction...';
                sendButton.disabled = true;

                // Build transaction on server
                const response = await fetch('/mini-app/build-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient: recipientAddress,
                        asset: asset,
                        amount: amount,
                        memo: memo
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to build transaction');
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Transaction build failed');
                }

                // Build XDR using Stellar SDK (this also calculates proper fees)
                const xdrResult = await buildTransactionXDR(result.transaction);
                
                // Calculate proper fees based on XLM equivalent
                const properFees = await window.Utils.calculateProperFees(result.transaction);
                
                // Store transaction data for signing
                window.currentTransactionData = {
                    xdr: xdrResult,
                    transaction: result.transaction,
                    fees: properFees
                };

                // Show transaction details for confirmation
                window.UIManager.showTransactionConfirmation(result.transaction, properFees);

            } catch (error) {
                console.error('Transaction build failed:', error);
                alert(`Transaction failed: ${error.message}`);

                // Reset button
                const sendButton = document.querySelector('.btn-primary');
                sendButton.textContent = 'üöÄ Send Payment';
                sendButton.disabled = false;
            }
        }

        // showTransactionConfirmation moved to UIManager module

        function goBackToSendPayment() {
                            window.UIManager.showSendPayment();
        }

        async function signAndSubmitTransaction() {
            try {
                // Show password prompt
                const password = prompt('Enter your password to sign this transaction:');
                if (!password) {
                    alert('Password required to sign transaction');
                    return;
                }

                // Show loading state
                const confirmButton = document.querySelector('.btn-primary');
                const originalText = confirmButton.textContent;
                confirmButton.textContent = '‚è≥ Signing Transaction...';
                confirmButton.disabled = true;

                // Get the transaction data from the confirmation screen
                const transactionData = window.currentTransactionData;
                if (!transactionData) {
                    throw new Error('No transaction data found');
                }

                console.log('üîç Transaction data for signing:', transactionData);
                console.log('üîç XDR to sign:', transactionData.xdr);

                // Sign and submit the transaction using the client-side manager (handles everything)
                const result = await signTransactionWithPassword(transactionData.xdr, password);

                if (!result.success) {
                    throw new Error(result.error || 'Transaction failed');
                }

                // Show success message (result already contains the hash)
                window.UIManager.showTransactionSuccess(result.hash);

            } catch (error) {
                console.error('Transaction signing failed:', error);
                alert(`Signing failed: ${error.message}`);

                // Reset button
                const confirmButton = document.querySelector('.btn-primary');
                confirmButton.textContent = '‚úÖ Confirm & Sign';
                confirmButton.disabled = false;
            }
        }

        // High-security signing for withdrawals (requires password) - FULLY CLIENT-SIDE
        async function signTransactionWithPassword(xdr, password) {
            try {
                // Import the encryption utilities
                if (typeof EncryptionUtils === 'undefined') {
                    throw new Error('Encryption utilities not loaded');
                }

                // Retrieve and decrypt API keys from Telegram Cloud Storage
                const apiKeys = await EncryptionUtils.retrieveTelegramKey(password);
                if (!apiKeys) {
                    throw new Error('No Telegram Cloud Storage key found');
                }

                console.log('‚úÖ Retrieved API keys for high-security signing');

                // Get Telegram ID for logging
                const telegramId = await getTelegramId();
                console.log('üîç Using Telegram ID for logging:', telegramId);

                // Use the new client-side transaction manager for complete flow
                const transactionManager = createClientSideTransactionManager();
                
                console.log('üöÄ Starting complete client-side transaction flow...');
                
                // This will handle everything: session creation, stamping, Turnkey API, signing, and submission
                const result = await transactionManager.signAndSubmitTransaction(
                    xdr, 
                    telegramId,
                    password
                );
                
                console.log('‚úÖ Complete client-side transaction successful:', result);
                
                return {
                    success: true,
                    signed_xdr: result.signed_xdr,
                    hash: result.hash,
                    source: 'client-complete'
                };

            } catch (error) {
                console.error('High-security signing failed:', error);
                return { success: false, error: error.message };
            }
        }

        // Session-based signing for automated operations (no password required)
        async function signTransactionWithSession(xdr, operationType = 'swap') {
            try {
                console.log('ü§ñ Starting session-based signing for:', operationType);

                // Create session transaction stamper (no keys needed)
                const stamper = createSessionTransactionStamper();

                // Sign using session keys via Python bot
                const stampResult = await stamper.stamp(xdr, operationType);
                
                console.log('‚úÖ Session-based signing successful');
                console.log('üîç Stamp result:', stampResult);
                console.log('üîç Security level:', stampResult.securityLevel);
                
                return {
                    success: true,
                    signed_xdr: stampResult.signedXdr,
                    source: 'python-bot',
                    securityLevel: 'low',
                    operationType: operationType
                };

            } catch (error) {
                console.error('Session-based signing failed:', error);
                return { success: false, error: error.message };
            }
        }

        async function getTelegramId() {
            try {
                console.log('üîç Getting Telegram ID from authenticator...');
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();
                console.log('üîç Authenticator response:', authData);
                
                const telegramId = authData.authenticator_info?.user?.telegram_id;
                console.log('üîç Extracted Telegram ID:', telegramId);
                
                if (!telegramId) {
                    console.error('‚ùå No telegram_id found in authenticator response');
                    // Fallback: try to get from Telegram WebApp
                    const webAppUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
                    if (webAppUser?.id) {
                        console.log('üîç Using fallback Telegram ID from WebApp:', webAppUser.id);
                        return webAppUser.id;
                    }
                }
                
                return telegramId;
            } catch (error) {
                console.error('Failed to get Telegram ID:', error);
                // Fallback: try to get from Telegram WebApp
                const webAppUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
                if (webAppUser?.id) {
                    console.log('üîç Using fallback Telegram ID from WebApp:', webAppUser.id);
                    return webAppUser.id;
                }
                return null;
            }
        }

        async function submitTransactionToNetwork(signedXdr) {
            try {
                // Submit to Stellar network via Horizon
                const response = await fetch('https://horizon.stellar.org/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `tx=${encodeURIComponent(signedXdr)}`
                });

                const result = await response.json();

                if (response.ok) {
                    // Log successful transaction to backend
                    await logTransactionToBackend(result.hash);
                    
                    return {
                        success: true,
                        hash: result.hash,
                        ledger: result.ledger
                    };
                } else {
                    return {
                        success: false,
                        error: result.extras?.result_codes?.operations?.join(', ') || result.detail || 'Transaction failed'
                    };
                }

            } catch (error) {
                console.error('Network submission failed:', error);
                return { success: false, error: error.message };
            }
        }

        async function logTransactionToBackend(txHash) {
            try {
                // Get current transaction data
                const transactionData = window.currentTransactionData;
                if (!transactionData) {
                    console.warn('No transaction data found for logging');
                    return;
                }

                // Get user's telegram_id
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();
                const telegram_id = authData.authenticator_info.user.telegram_id;

                // Log to backend
                const response = await fetch('/mini-app/log-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: telegram_id,
                        xdr: transactionData.xdr,
                        amount: transactionData.transaction.amount,
                        asset: transactionData.transaction.asset,
                        recipient: transactionData.transaction.recipient,
                        tx_hash: txHash
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Transaction logged to backend');
                } else {
                    console.warn('‚ö†Ô∏è Failed to log transaction to backend');
                }

            } catch (error) {
                console.error('‚ùå Error logging transaction:', error);
            }
        }

        // showTransactionSuccess moved to UIManager module

        function showAssetManagement() {
            // TODO: Implement asset management interface
            alert('Asset Management feature coming soon!');
        }

        function showTransactionHistory() {
            // TODO: Implement transaction history interface
            alert('Transaction History feature coming soon!');
        }

        function testTurnkeyStamper() {
            // Navigate to the test page within the mini app
            window.location.href = '/test-turnkey-stamper';
        }

        // Enhanced client-side XDR building with Stellar SDK bundle
        async function buildTransactionXDR(transactionData) {
            try {
                console.log('üîç Building XDR client-side with Stellar SDK bundle...');
                console.log('Transaction data:', transactionData);
                
                // Check if Stellar SDK bundle is available
                if (typeof window.StellarSdk === 'undefined') {
                    console.log('‚ö†Ô∏è Stellar SDK bundle not loaded, trying fallback...');
                    // Fallback to backend XDR building
                    return await buildXDRWithBackend(transactionData);
                }
                
                // Use the enhanced transaction builder
                const transactionBuilder = createStellarTransactionBuilder();
                await transactionBuilder.initialize();
                
                // Get user's public key from the wallet
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();
                const sourcePublicKey = authData.authenticator_info.user.public_key;
                
                console.log('Source public key:', sourcePublicKey);
                
                // Build transaction using the enhanced builder
                const result = await transactionBuilder.buildPaymentTransaction(
                    sourcePublicKey,
                    transactionData.recipient,
                    transactionData.amount,
                    transactionData.asset,
                    transactionData.memo
                );
                
                console.log('‚úÖ XDR built successfully with Stellar SDK bundle');
                console.log('Transaction source:', result.source);
                return result.xdr;
                
            } catch (error) {
                console.error('‚ùå Error building XDR:', error);
                throw error;
            }
        }

        // Fallback: Build XDR using backend
        async function buildXDRWithBackend(transactionData) {
            try {
                console.log('üîÑ Using backend XDR building as fallback...');
                
                // Get user's public key from the wallet
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();
                const sourcePublicKey = authData.authenticator_info.user.public_key;
                
                // Use backend to build proper XDR with Stellar SDK
                const response = await fetch('/mini-app/build-xdr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sourcePublicKey: sourcePublicKey,
                        transactionData: transactionData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Backend XDR building failed: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ XDR built by backend fallback:', result.xdr);
                return result.xdr;
                
            } catch (error) {
                console.error('‚ùå Backend XDR building also failed:', error);
                throw error;
            }
        }

        // Proper signed XDR construction
        async function constructSignedXdr(originalXdr, signature, publicKey) {
            try {
                console.log('üîß Constructing signed XDR...');
                console.log('Original XDR:', originalXdr);
                console.log('Signature:', signature);
                console.log('Public Key:', publicKey);
                
                // Try backend first (for EC2)
                try {
                    const response = await fetch('/mini-app/construct-signed-xdr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            originalXdr: originalXdr,
                            signature: signature,
                            publicKey: publicKey
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Signed XDR constructed by backend:', result.signedXdr);
                        return result.signedXdr;
                    } else {
                        throw new Error(`Backend returned ${response.status}`);
                    }
                } catch (backendError) {
                    console.log('‚ö†Ô∏è Backend XDR construction not available:', backendError.message);
                    console.log('üîÑ Using client-side fallback...');
                    
                    // For local testing, we'll try a different approach
                    // The signature we got should be valid, but we need to construct it properly
                    console.log('‚ö†Ô∏è Client-side XDR construction not yet implemented');
                    console.log('üìù Returning original XDR for testing');
                    return originalXdr;
                }
                
            } catch (error) {
                console.error('‚ùå Error constructing signed XDR:', error);
                return originalXdr;
            }
        }
    </script>
</body>

</html>
