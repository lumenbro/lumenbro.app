<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LumenBro Mini App</title>
    <link rel="stylesheet" href="/mini-app/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/turnkey.js?v=2"></script> <!-- Updated to esbuild output with cache busting -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body>
    <div id="content" class="fade-in">
        <!-- Wallet-First Interface -->
        <div id="wallet-interface" style="display: none;">
            <h1>LumenBro Wallet</h1>
            <div class="wallet-balance">
                <div class="balance-card">
                    <h3>üí∞ Balance</h3>
                    <div class="balance-amount">Loading...</div>
                    <div class="balance-currency">XLM</div>
                </div>
            </div>
            
            <div class="wallet-actions">
                <button onclick="showSendPayment()" class="btn-primary">üí∏ Send Payment</button>
                <button onclick="showAssetManagement()" class="btn-success">üîÑ Manage Assets</button>
                <button onclick="showTransactionHistory()" class="btn-info">üìä History</button>
            </div>
            
            <div class="wallet-status">
                <div id="connection-status" class="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </div>
        
        <!-- Auth Interface (Fallback) -->
        <div id="auth-interface">
            <h1>Welcome to LumenBro Trading Bot</h1>
            <div class="flex flex-col items-center gap-4">
                <button onclick="window.register()" class="btn-primary">üìù Register</button>
                <button onclick="window.login()" class="btn-success">üîê Login</button>
                <button onclick="window.recover()" class="btn-warning">üîë Recover</button>
            </div>
            
            <!-- Quick access to wallet (if authenticated) -->
            <div id="quick-wallet-access" style="display: none; margin-top: 20px;">
                <button onclick="showWallet()" class="btn-info">üíº Open Wallet</button>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav" style="display: none;">
            <div class="nav-item active" onclick="showWallet()">
                <div class="nav-icon">üíº</div>
                <div class="nav-label">Wallet</div>
            </div>
            <div class="nav-item" onclick="showAuth()">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Settings</div>
            </div>
        </nav>
    </div>
    <script src="/recovery-credentials.js"></script>
    <script src="/mini-app/encryption-utils.js"></script>
    <script src="/mini-app/recovery-key-generator.js"></script>
    <script src="/mini-app/export-utils.js"></script>
    <script src="/mini-app/auth.js"></script>
    <script src="/mini-app/login.js"></script>
    <script src="/mini-app/recovery.js"></script>
    <script src="/mini-app/clear.js"></script>  <!-- New script for clear -->
    <script src="/mini-app/mobile-debug.js"></script>  <!-- Mobile debugging -->
    <script src="/mini-app/mobile-encryption-fix.js"></script>  <!-- Mobile encryption fixes -->
    <style>
        .status {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .status.success {
            background: rgba(57, 217, 138, 0.1);
            color: var(--success);
            border-color: rgba(57, 217, 138, 0.3);
        }
        .status.error {
            background: rgba(255, 107, 107, 0.1);
            color: var(--danger);
            border-color: rgba(255, 107, 107, 0.3);
        }
        .status.loading {
            background: rgba(79, 138, 255, 0.1);
            color: var(--primary);
            border-color: rgba(79, 138, 255, 0.3);
        }
    </style>
    <script>
        window.addEventListener('load', function () {  // Wait for all resources (including bundle)
            console.log('All loaded ‚Äì checking Turnkey...');
            if (!window.Turnkey) {
                console.error('Turnkey global not set after load. Check bundle content for errors.');
            } else {
                console.log('Turnkey ready:', window.Turnkey);
            }
            const telegramApp = window.Telegram.WebApp;
            window.params = new URLSearchParams(window.location.search);
            window.orgId = window.params.get('orgId') || 'global-org-id';  // Set global orgId from query param
            window.email = window.params.get('email') || '';  // Set global email from query param
            const action = window.params.get('action');
            if (action === 'register') {
                window.register();
            } else if (action === 'login') {
                window.login();
            } else if (action === 'recover') {
                window.recover();
            } else if (action === 'export') {
                // Ensure orgId/email are available to the export form
                window.orgId = window.params.get('orgId') || window.orgId || '';
                window.email = window.params.get('email') || window.email || '';
                window.showExportForm();
            } else if (action === 'auto-clear') {
                window.autoClearCloudStorage();
            }

            // Debug function and button (made global)
            window.checkCloudStorage = async function() {
                return new Promise((resolve, reject) => {
                    Telegram.WebApp.CloudStorage.getItem('TURNKEY_API_KEY', (error, value) => {
                        if (error) {
                            console.error('Cloud storage error:', error);
                            reject(error);
                        } else {
                            console.log('Stored TURNKEY_API_KEY:', value ? JSON.parse(value) : 'No key stored');
                            resolve(value ? JSON.parse(value) : null);
                        }
                    });
                });
            }

            // Add buttons to trigger debug and clear
            document.getElementById('content').innerHTML += '<button onclick="window.checkCloudStorage()" class="btn-info">üîç Check Cloud Storage</button>';
            document.getElementById('content').innerHTML += '<button onclick="window.showClearWarning()" class="btn-danger">‚ö†Ô∏è Clear Data</button>';
            
            // Only initialize wallet interface if no specific action is requested
            if (!action) {
                initializeWalletInterface();
            }
        });
        
        // Wallet interface functions
        function initializeWalletInterface() {
            console.log('Initializing wallet interface...');
            
            // Check if user is authenticated
            checkUserAuthentication().then(isAuthenticated => {
                if (isAuthenticated) {
                    showWallet();
                } else {
                    showAuth();
                }
            });
        }
        
        async function checkUserAuthentication() {
            try {
                // Check if user has stored keys
                const storedKey = await window.checkCloudStorage();
                return !!storedKey;
            } catch (error) {
                console.log('User not authenticated:', error);
                return false;
            }
        }
        
        function showWallet() {
            const authInterface = document.getElementById('auth-interface');
            const walletInterface = document.getElementById('wallet-interface');
            const bottomNav = document.querySelector('.bottom-nav');
            
            if (authInterface) authInterface.style.display = 'none';
            if (walletInterface) walletInterface.style.display = 'block';
            if (bottomNav) bottomNav.style.display = 'flex';
            
            // Load wallet data
            loadWalletData();
        }
        
        function showAuth() {
            const walletInterface = document.getElementById('wallet-interface');
            const authInterface = document.getElementById('auth-interface');
            const bottomNav = document.querySelector('.bottom-nav');
            
            if (walletInterface) walletInterface.style.display = 'none';
            if (authInterface) authInterface.style.display = 'block';
            if (bottomNav) bottomNav.style.display = 'none';
        }
        
        async function loadWalletData() {
            try {
                // Update connection status
                updateConnectionStatus('Connecting to wallet...', 'connecting');
                
                // TODO: Load actual wallet data from your API
                // For now, show mock data
                setTimeout(() => {
                    const balanceAmount = document.querySelector('.balance-amount');
                    if (balanceAmount) {
                        balanceAmount.textContent = '1,234.56';
                    }
                    updateConnectionStatus('Connected', 'connected');
                }, 1000);
                
            } catch (error) {
                console.error('Error loading wallet data:', error);
                updateConnectionStatus('Connection failed', 'error');
            }
        }
        
        function updateConnectionStatus(text, status) {
            const statusElement = document.getElementById('connection-status');
            if (!statusElement) return;
            
            const statusDot = statusElement.querySelector('.status-dot');
            const statusText = statusElement.querySelector('.status-text');
            
            if (statusText) statusText.textContent = text;
            if (statusDot) statusDot.className = `status-dot ${status}`;
        }
        
        function showSendPayment() {
            // TODO: Implement send payment interface
            alert('Send Payment feature coming soon!');
        }
        
        function showAssetManagement() {
            // TODO: Implement asset management interface
            alert('Asset Management feature coming soon!');
        }
        
        function showTransactionHistory() {
            // TODO: Implement transaction history interface
            alert('Transaction History feature coming soon!');
        }
    </script>
</body>

</html>
