<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LumenBro Mini App</title>
    <link rel="stylesheet" href="/mini-app/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/turnkey.js?v=2"></script> <!-- Updated to esbuild output with cache busting -->
    <!-- Use stellar-plus for transaction building -->
    <script>
        // Debug: Check what's available
        console.log('üîç Checking available packages...');
        console.log('Available globals:', Object.keys(window).filter(key => key.toLowerCase().includes('stellar')));
        
        // Try to load stellar-plus
        console.log('üîç Attempting to load stellar-plus...');
    </script>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body>
    <div id="content" class="fade-in">
        <!-- Wallet-First Interface -->
        <div id="wallet-interface" style="display: none;">
            <h1>LumenBro Wallet</h1>
            <div class="wallet-balance">
                <div class="balance-card">
                    <h3>üí∞ Balance</h3>
                    <div class="balance-amount">Loading...</div>
                    <div class="balance-currency">XLM</div>
                </div>
            </div>

            <div class="wallet-actions">
                <button onclick="showSendPayment()" class="btn-primary">üí∏ Send Payment</button>    
                <button onclick="showAssetManagement()" class="btn-success">üîÑ Manage Assets</button>
                <button onclick="showTransactionHistory()" class="btn-info">üìä History</button>     
            </div>

            <div class="wallet-status">
                <div id="connection-status" class="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </div>

        <!-- Auth Interface (Fallback) -->
        <div id="auth-interface">
        <h1>Welcome to LumenBro Trading Bot</h1>
            <div class="flex flex-col items-center gap-4">
                <button onclick="window.register()" class="btn-primary">üìù Register</button>        
                <button onclick="window.login()" class="btn-success">üîê Login</button>
                <button onclick="window.recover()" class="btn-warning">üîë Recover</button>
            </div>

            <!-- Quick access to wallet (if authenticated) -->
            <div id="quick-wallet-access" style="display: none; margin-top: 20px;">
                <button onclick="showWallet()" class="btn-info">üíº Open Wallet</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" style="display: none;">
            <div class="nav-item active" onclick="showWallet()">
                <div class="nav-icon">üíº</div>
                <div class="nav-label">Wallet</div>
            </div>
            <div class="nav-item" onclick="showAuth()">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Settings</div>
            </div>
        </nav>
    </div>
    <script src="/recovery-credentials.js"></script>
    <script src="/mini-app/encryption-utils.js"></script>
    <script src="/mini-app/recovery-key-generator.js"></script>
    <script src="/mini-app/export-utils.js"></script>
    <script src="/mini-app/auth.js"></script>
    <script src="/mini-app/login.js"></script>
    <script src="/mini-app/recovery.js"></script>
    <script src="/mini-app/clear.js"></script>  <!-- New script for clear -->
    <script src="/mini-app/mobile-debug.js"></script>  <!-- Mobile debugging -->
    <script src="/mini-app/mobile-encryption-fix.js"></script>  <!-- Mobile encryption fixes -->
    <script src="/mini-app/transaction-stamper.js"></script>  <!-- Transaction signing stamper -->
    <style>
        .status {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .status.success {
            background: rgba(57, 217, 138, 0.1);
            color: var(--success);
            border-color: rgba(57, 217, 138, 0.3);
        }
        .status.error {
            background: rgba(255, 107, 107, 0.1);
            color: var(--danger);
            border-color: rgba(255, 107, 107, 0.3);
        }
        .status.loading {
            background: rgba(79, 138, 255, 0.1);
            color: var(--primary);
            border-color: rgba(79, 138, 255, 0.3);
        }
    </style>
    <script>
        window.addEventListener('load', function () {  // Wait for all resources (including bundle)
            console.log('All loaded ‚Äì checking Turnkey...');
            if (!window.Turnkey) {
                console.error('Turnkey global not set after load. Check bundle content for errors.');
            } else {
                console.log('Turnkey ready:', window.Turnkey);
            }
            const telegramApp = window.Telegram.WebApp;
            window.params = new URLSearchParams(window.location.search);
            window.orgId = window.params.get('orgId') || 'global-org-id';  // Set global orgId from query param
            window.email = window.params.get('email') || '';  // Set global email from query param
            const action = window.params.get('action');
            if (action === 'register') {
                window.register();
            } else if (action === 'login') {
                window.login();
            } else if (action === 'recover') {
                window.recover();
            } else if (action === 'export') {
                // Ensure orgId/email are available to the export form
                window.orgId = window.params.get('orgId') || window.orgId || '';
                window.email = window.params.get('email') || window.email || '';
                window.showExportForm();
            } else if (action === 'auto-clear') {
                window.autoClearCloudStorage();
            }

            // Debug function and button (made global)
            window.checkCloudStorage = async function() {
                return new Promise((resolve, reject) => {
                    Telegram.WebApp.CloudStorage.getItem('TURNKEY_API_KEY', (error, value) => {
                        if (error) {
                            console.error('Cloud storage error:', error);
                            reject(error);
                        } else {
                            console.log('Stored TURNKEY_API_KEY:', value ? JSON.parse(value) : 'No key stored');
                            resolve(value ? JSON.parse(value) : null);
                        }
                    });
                });
            }

            // Add debug buttons only for development/testing, not on sensitive pages
            const sensitiveActions = ['login', 'export', 'recover'];
            const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const showDebugButtons = isDevelopment && !sensitiveActions.includes(action);

            if (showDebugButtons) {
                document.getElementById('content').innerHTML += '<button onclick="window.checkCloudStorage()" class="btn-info">üîç Check Cloud Storage</button>';
                document.getElementById('content').innerHTML += '<button onclick="window.showClearWarning()" class="btn-danger">‚ö†Ô∏è Clear Data</button>';
            }

            // Only initialize wallet interface if no specific action is requested
            if (!action) {
                initializeWalletInterface();
            }
        });

        // Wallet interface functions
        function initializeWalletInterface() {
            console.log('Initializing wallet interface...');

            // Check if user is authenticated
            checkUserAuthentication().then(isAuthenticated => {
                if (isAuthenticated) {
                    showWallet();
                } else {
                    showAuth();
                }
            });
        }

        async function checkUserAuthentication() {
            try {
                console.log('üîç Checking user authentication...');
                // Check if user has stored keys
                const storedKey = await window.checkCloudStorage();
                console.log('üîç Stored key result:', storedKey ? 'Found' : 'Not found');
                const isAuthenticated = !!storedKey;
                console.log('üîç Authentication result:', isAuthenticated);
                return isAuthenticated;
            } catch (error) {
                console.log('‚ùå User not authenticated:', error);
                return false;
            }
        }

        function showWallet() {
            // Recreate the wallet interface
            document.getElementById('content').innerHTML = `
                <div class="fade-in">
                    <!-- Wallet Interface -->
                    <div id="wallet-interface">
                        <h1>LumenBro Wallet</h1>
                        <div class="wallet-balance">
                            <div class="balance-card">
                                <h3>üí∞ XLM Balance</h3>
                                <div class="balance-amount">Loading...</div>
                                <div class="balance-currency">XLM</div>
                            </div>
                        </div>

                        <div class="wallet-assets">
                            <h3>ü™ô All Assets</h3>
                            <div id="assets-list" class="assets-list">
                                <div class="loading-assets">Loading assets...</div>
                            </div>
                        </div>

                        <div class="wallet-actions">
                            <button onclick="showSendPayment()" class="btn-primary">üí∏ Send Payment</button>
                            <button onclick="showAssetManagement()" class="btn-success">üîÑ Manage Assets</button>
                            <button onclick="showTransactionHistory()" class="btn-info">üìä History</button>
                        </div>

                        <div class="wallet-status">
                            <div id="connection-status" class="status-indicator">
                                <span class="status-dot"></span>
                                <span class="status-text">Connecting...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Navigation -->
                <nav class="bottom-nav">
                    <div class="nav-item active" onclick="showWallet()">
                        <div class="nav-icon">üíº</div>
                        <div class="nav-label">Wallet</div>
                    </div>
                    <div class="nav-item" onclick="showAuth()">
                        <div class="nav-icon">‚öôÔ∏è</div>
                        <div class="nav-label">Settings</div>
                    </div>
                </nav>
            `;

            // Load wallet data
            loadWalletData();
        }

        function showAuth() {
            const walletInterface = document.getElementById('wallet-interface');
            const authInterface = document.getElementById('auth-interface');
            const bottomNav = document.querySelector('.bottom-nav');

            if (walletInterface) walletInterface.style.display = 'none';
            if (authInterface) authInterface.style.display = 'block';
            if (bottomNav) bottomNav.style.display = 'flex';

            // Show the main menu (settings) with all functions
            document.getElementById('content').innerHTML = `
                <div class="fade-in">
                    <h1>üîß Settings</h1>
                    <div class="flex flex-col items-center gap-4" style="margin-bottom: 40px;">
                        <button onclick="window.register()" class="btn-primary">üìù Register</button>
                        <button onclick="window.login()" class="btn-success">üîê Login</button>      
                        <button onclick="window.recover()" class="btn-warning">üîë Recovery</button> 
                        <button onclick="window.export()" class="btn-info">üì§ Export Keys</button>  
                        <button onclick="testTurnkeyStamper()" class="btn-secondary">üß™ Test Turnkey</button>
                        <button onclick="showWallet()" class="btn-warning">üîß Force Show Wallet</button>  
                    </div>

                    <!-- Quick access to wallet (if authenticated) -->
                    <div id="quick-wallet-access" style="display: none; margin-top: 20px;">
                        <button onclick="showWallet()" class="btn-info">üíº Open Wallet</button>     
                    </div>
                </div>

                <!-- Bottom Navigation -->
                <nav class="bottom-nav">
                    <div class="nav-item" onclick="showWallet()">
                        <div class="nav-icon">üíº</div>
                        <div class="nav-label">Wallet</div>
                    </div>
                    <div class="nav-item active" onclick="showAuth()">
                        <div class="nav-icon">‚öôÔ∏è</div>
                        <div class="nav-label">Settings</div>
                    </div>
                </nav>
            `;
        }

        async function loadWalletData() {
            try {
                // Update connection status
                updateConnectionStatus('Loading balance...', 'connecting');

                // Get user's public key from authenticator endpoint
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();

                if (!authData.success) {
                    throw new Error('Failed to get user data');
                }

                const publicKey = authData.authenticator_info.user.public_key;
                console.log('Loading balance for public key:', publicKey);

                // Use Stellar-Plus to get real balance
                // For now, we'll use a simple fetch to Stellar RPC
                // Later we can add the full Stellar-Plus library
                const stellarResponse = await fetch(`https://horizon.stellar.org/accounts/${publicKey}`);
                const accountData = await stellarResponse.json();

                if (accountData.detail) {
                    throw new Error('Account not found on Stellar network');
                }

                // Find XLM balance
                const xlmBalance = accountData.balances.find(balance =>
                    balance.asset_type === 'native'
                );

                const balanceAmount = document.querySelector('.balance-amount');
                if (balanceAmount && xlmBalance) {
                    balanceAmount.textContent = parseFloat(xlmBalance.balance).toFixed(2);
                }

                // Display all assets
                displayAllAssets(accountData.balances);

                // Show total assets count
                const totalAssets = accountData.balances.length;
                console.log(`Account has ${totalAssets} assets (including XLM)`);

                updateConnectionStatus('Connected', 'connected');

            } catch (error) {
                console.error('Error loading wallet data:', error);
                updateConnectionStatus('Connection failed', 'error');

                // Show error in balance
                const balanceAmount = document.querySelector('.balance-amount');
                if (balanceAmount) {
                    balanceAmount.textContent = 'Error';
                }
            }
        }

        function updateConnectionStatus(text, status) {
            const statusElement = document.getElementById('connection-status');
            if (!statusElement) return;

            const statusDot = statusElement.querySelector('.status-dot');
            const statusText = statusElement.querySelector('.status-text');

            if (statusText) statusText.textContent = text;
            if (statusDot) statusDot.className = `status-dot ${status}`;
        }

        async function displayAllAssets(balances) {
            const assetsList = document.getElementById('assets-list');
            if (!assetsList) return;

            // Clear loading message
            assetsList.innerHTML = '';

            // Process each balance and fetch asset metadata
            for (const balance of balances) {
                const assetCard = document.createElement('div');
                assetCard.className = 'asset-card';

                let assetName, assetCode, assetIcon, assetIssuer;

                if (balance.asset_type === 'native') {
                    // XLM
                    assetName = 'Stellar Lumens';
                    assetCode = 'XLM';
                    assetIcon = '/media/stellar-logo.svg';
                    assetIssuer = null;
                } else if (balance.asset_type === 'credit_alphanum4' || balance.asset_type === 'credit_alphanum12') {
                    // Traditional assets
                    assetName = balance.asset_code || 'Unknown Asset';
                    assetCode = balance.asset_code;
                    assetIcon = 'ü™ô'; // Default fallback
                    assetIssuer = balance.asset_issuer;
                } else {
                    // Soroban or other assets
                    assetName = 'Smart Contract Asset';
                    assetCode = 'SOROBAN';
                    assetIcon = 'ü§ñ';
                    assetIssuer = null;
                }

                // Create initial card with fallback icon
                const balanceAmount = parseFloat(balance.balance).toFixed(7);

                assetCard.innerHTML = `
                    <div class="asset-info">
                        <div class="asset-icon">
                            <img alt="${assetCode}" class="asset-icon-img" style="display: ${balance.asset_type === 'native' ? 'block' : 'none'};" src="${balance.asset_type === 'native' ? assetIcon : ''}">
                            <span class="asset-icon-fallback" style="display: ${balance.asset_type === 'native' ? 'none' : 'inline'}">${balance.asset_type === 'native' ? '' : assetIcon}</span>        
                        </div>
                        <div class="asset-details">
                            <div class="asset-name">${assetName}</div>
                            <div class="asset-code">${assetCode}</div>
                        </div>
                    </div>
                    <div class="asset-balance">
                        <div class="balance-amount">${balanceAmount}</div>
                        <div class="balance-limit">${balance.limit ? `Limit: ${balance.limit}` : ''}</div>
                    </div>
                `;

                assetsList.appendChild(assetCard);

                // Fetch real asset metadata if not XLM
                if (balance.asset_type !== 'native' && assetIssuer) {
                    try {
                        await fetchAssetMetadata(assetCode, assetIssuer, assetCard);
                    } catch (error) {
                        console.log(`Failed to fetch metadata for ${assetCode}:`, error);
                        // Keep fallback icon
                    }
                }
            }

            // If no assets found
            if (balances.length === 0) {
                assetsList.innerHTML = '<div class="no-assets">No assets found</div>';
            }
        }

        async function fetchAssetMetadata(assetCode, assetIssuer, assetCard) {
            try {
                // Try Stellar Expert API first (via our proxy)
                const stellarExpertUrl = `/mini-app/asset-metadata/${assetCode}/${assetIssuer}`;    
                const response = await fetch(stellarExpertUrl);

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.data.icon && result.data.icon !== '') {
                        // Update the asset card with real icon
                        const iconContainer = assetCard.querySelector('.asset-icon');
                        const fallbackSpan = iconContainer.querySelector('.asset-icon-fallback');   
                        const imgElement = iconContainer.querySelector('.asset-icon-img');

                        if (imgElement && fallbackSpan) {
                            imgElement.src = result.data.icon;
                            imgElement.style.display = 'block';
                            fallbackSpan.style.display = 'none';
                        }

                        // Update asset name if available
                        if (result.data.name && result.data.name !== assetCode) {
                            const nameElement = assetCard.querySelector('.asset-name');
                            if (nameElement) {
                                nameElement.textContent = result.data.name;
                            }
                        }

                        console.log(`‚úÖ Loaded Stellar Expert metadata for ${assetCode}:`, result.data.name, result.data.icon);
                        return;
                    }
                }

                // Fallback: Try TOML file if Stellar Expert doesn't have icon
                await fetchAssetFromToml(assetCode, assetIssuer, assetCard);

            } catch (error) {
                console.log(`‚ùå Stellar Expert failed for ${assetCode}:`, error);
                // Try TOML fallback
                try {
                    await fetchAssetFromToml(assetCode, assetIssuer, assetCard);
                } catch (tomlError) {
                    console.log(`‚ùå TOML also failed for ${assetCode}:`, tomlError);
                }
            }
        }

        async function fetchAssetFromToml(assetCode, assetIssuer, assetCard) {
            try {
                // Use our TOML proxy endpoint
                const tomlUrl = `/mini-app/toml-metadata/${assetCode}/${assetIssuer}`;
                const tomlResponse = await fetch(tomlUrl);

                if (tomlResponse.ok) {
                    const result = await tomlResponse.json();

                    if (result.success && result.data.icon) {
                        const iconContainer = assetCard.querySelector('.asset-icon');
                        const fallbackSpan = iconContainer.querySelector('.asset-icon-fallback');   
                        const imgElement = iconContainer.querySelector('.asset-icon-img');

                        if (imgElement && fallbackSpan) {
                            imgElement.src = result.data.icon;
                            imgElement.style.display = 'block';
                            fallbackSpan.style.display = 'none';
                        }

                        // Update asset name if available
                        if (result.data.name && result.data.name !== assetCode) {
                            const nameElement = assetCard.querySelector('.asset-name');
                            if (nameElement) {
                                nameElement.textContent = result.data.name;
                            }
                        }

                        console.log(`‚úÖ Loaded TOML metadata for ${assetCode}:`, result.data.name, result.data.icon);
                    }
                }
            } catch (error) {
                console.log(`‚ùå TOML fetch failed for ${assetCode}:`, error);
            }
        }

        function showSendPayment() {
            // Show send payment interface
            document.getElementById('content').innerHTML = `
                <div class="fade-in">
                    <h1>üí∏ Send Payment</h1>

                    <div class="send-payment-form">
                        <div class="form-group">
                            <label for="recipientAddress">Recipient Address</label>
                            <input type="text" id="recipientAddress" placeholder="G..." class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="assetSelect">Asset</label>
                            <select id="assetSelect" class="form-select">
                                <option value="XLM">XLM (Native)</option>
                                <!-- Other assets will be populated dynamically -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="amount">Amount</label>
                            <input type="number" id="amount" placeholder="0.0000000" step="0.0000001" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="memo">Memo (Optional)</label>
                            <input type="text" id="memo" placeholder="Payment for..." class="form-input">
                        </div>

                        <div class="fee-info">
                            <p>üí∞ Fee: <span id="feeAmount">0.00001 XLM</span></p>
                            <p>üìä Service Fee: <span id="serviceFee">0.00001 XLM</span></p>
                        </div>

                        <div class="form-actions">
                            <button onclick="goBackToWallet()" class="btn-secondary">‚Üê Back</button>
                            <button onclick="buildAndSignTransaction()" class="btn-primary">üöÄ Send Payment</button>
                        </div>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item" onclick="showWallet()">
                        <div class="nav-icon">üíº</div>
                        <div class="nav-label">Wallet</div>
                    </div>
                    <div class="nav-item" onclick="showAuth()">
                        <div class="nav-icon">‚öôÔ∏è</div>
                        <div class="nav-label">Settings</div>
                    </div>
                </nav>
            `;

            // Populate asset select with user's assets
            populateAssetSelect();
        }

        function populateAssetSelect() {
            const assetSelect = document.getElementById('assetSelect');
            if (!assetSelect) return;

            // Clear existing options except XLM
            assetSelect.innerHTML = '<option value="XLM">XLM (Native)</option>';

            // Get all asset cards and add them to select
            const assetCards = document.querySelectorAll('.asset-card');
            assetCards.forEach(card => {
                const assetName = card.querySelector('.asset-name')?.textContent;
                const assetCode = card.querySelector('.asset-code')?.textContent;
                const balanceAmount = card.querySelector('.balance-amount')?.textContent;

                if (assetCode && assetCode !== 'XLM') {
                    const option = document.createElement('option');
                    option.value = assetCode;
                    option.textContent = `${assetCode} (${assetName || 'Unknown'}) - Balance: ${balanceAmount}`;
                    assetSelect.appendChild(option);
                }
            });
        }

        function goBackToWallet() {
            showWallet();
        }

        async function buildAndSignTransaction() {
            try {
                const recipientAddress = document.getElementById('recipientAddress').value.trim();  
                const assetCode = document.getElementById('assetSelect').value;
                const amount = document.getElementById('amount').value;
                const memo = document.getElementById('memo').value.trim();

                // Validation
                if (!recipientAddress || !amount) {
                    alert('Please fill in recipient address and amount');
                    return;
                }

                if (!recipientAddress.startsWith('G')) {
                    alert('Invalid Stellar address. Must start with G');
                    return;
                }

                // Show loading state
                const sendButton = document.querySelector('.btn-primary');
                const originalText = sendButton.textContent;
                sendButton.textContent = '‚è≥ Building Transaction...';
                sendButton.disabled = true;

                // Build transaction on server
                const response = await fetch('/mini-app/build-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient: recipientAddress,
                        asset: assetCode,
                        amount: amount,
                        memo: memo
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to build transaction');
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Transaction build failed');
                }

                // Build XDR using Stellar SDK
                const xdr = await buildTransactionXDR(result.transaction);
                
                // Store transaction data for signing
                window.currentTransactionData = {
                    xdr: xdr,
                    transaction: result.transaction,
                    fees: result.fees
                };

                // Show transaction details for confirmation
                showTransactionConfirmation(result.transaction, result.fees);

            } catch (error) {
                console.error('Transaction build failed:', error);
                alert(`Transaction failed: ${error.message}`);

                // Reset button
                const sendButton = document.querySelector('.btn-primary');
                sendButton.textContent = 'üöÄ Send Payment';
                sendButton.disabled = false;
            }
        }

        function showTransactionConfirmation(transaction, fees) {
            document.getElementById('content').innerHTML = `
                <div class="fade-in">
                    <h1>üîç Confirm Transaction</h1>

                    <div class="transaction-details">
                        <div class="detail-row">
                            <span class="label">Recipient:</span>
                            <span class="value">${transaction.recipient}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Amount:</span>
                            <span class="value">${transaction.amount} ${transaction.asset}</span>   
                        </div>
                        <div class="detail-row">
                            <span class="label">Network Fee:</span>
                            <span class="value">${fees.networkFee} XLM</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Service Fee:</span>
                            <span class="value">${fees.serviceFee} XLM</span>
                        </div>
                        <div class="detail-row total">
                            <span class="label">Total:</span>
                            <span class="value">${fees.total} XLM</span>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-bottom: 100px;">
                        <button onclick="goBackToSendPayment()" class="btn-secondary">‚Üê Back</button>
                        <button onclick="signAndSubmitTransaction()" class="btn-primary">‚úÖ Confirm & Sign</button>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item" onclick="showWallet()">
                        <div class="nav-icon">üíº</div>
                        <div class="nav-label">Wallet</div>
                    </div>
                    <div class="nav-item" onclick="showAuth()">
                        <div class="nav-icon">‚öôÔ∏è</div>
                        <div class="nav-label">Settings</div>
                    </div>
                </nav>
            `;
        }

        function goBackToSendPayment() {
            showSendPayment();
        }

        async function signAndSubmitTransaction() {
            try {
                // Show password prompt
                const password = prompt('Enter your password to sign this transaction:');
                if (!password) {
                    alert('Password required to sign transaction');
                    return;
                }

                // Show loading state
                const confirmButton = document.querySelector('.btn-primary');
                const originalText = confirmButton.textContent;
                confirmButton.textContent = '‚è≥ Signing Transaction...';
                confirmButton.disabled = true;

                // Get the transaction data from the confirmation screen
                const transactionData = window.currentTransactionData;
                if (!transactionData) {
                    throw new Error('No transaction data found');
                }

                console.log('üîç Transaction data for signing:', transactionData);
                console.log('üîç XDR to sign:', transactionData.xdr);

                // Sign the transaction using the custom stamper
                const signedResult = await signTransactionWithPassword(transactionData.xdr, password);

                if (!signedResult.success) {
                    throw new Error(signedResult.error || 'Transaction signing failed');
                }

                // Submit the signed transaction to the network
                const submitResult = await submitTransactionToNetwork(signedResult.signed_xdr);

                if (!submitResult.success) {
                    throw new Error(submitResult.error || 'Transaction submission failed');
                }

                // Show success message
                showTransactionSuccess(submitResult.hash);

            } catch (error) {
                console.error('Transaction signing failed:', error);
                alert(`Signing failed: ${error.message}`);

                // Reset button
                const confirmButton = document.querySelector('.btn-primary');
                confirmButton.textContent = '‚úÖ Confirm & Sign';
                confirmButton.disabled = false;
            }
        }

        async function signTransactionWithPassword(xdr, password) {
            try {
                // Import the encryption utilities
                if (typeof EncryptionUtils === 'undefined') {
                    throw new Error('Encryption utilities not loaded');
                }

                // Retrieve and decrypt API keys from Telegram Cloud Storage
                const apiKeys = await EncryptionUtils.retrieveTelegramKey(password);
                if (!apiKeys) {
                    throw new Error('No Telegram Cloud Storage key found');
                }

                console.log('‚úÖ Retrieved API keys for signing');

                // Create transaction stamper with decrypted keys
                const stamper = createTransactionStamper(apiKeys.apiPrivateKey, apiKeys.apiPublicKey);

                // Sign the XDR directly
                const stamp = await stamper.stamp(xdr);
                
                console.log('‚úÖ Transaction signed successfully');
                
                // For now, return the original XDR since the signature is embedded
                // TODO: Properly construct signed XDR with signature
                return {
                    success: true,
                    signed_xdr: xdr, // Will be properly constructed later
                    signature: stamp.signature,
                    publicKey: stamp.publicKey
                };

            } catch (error) {
                console.error('Signing with password failed:', error);
                return { success: false, error: error.message };
            }
        }

        async function submitTransactionToNetwork(signedXdr) {
            try {
                // Submit to Stellar network via Horizon
                const response = await fetch('https://horizon.stellar.org/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `tx=${encodeURIComponent(signedXdr)}`
                });

                const result = await response.json();

                if (response.ok) {
                    // Log successful transaction to backend
                    await logTransactionToBackend(result.hash);
                    
                    return {
                        success: true,
                        hash: result.hash,
                        ledger: result.ledger
                    };
                } else {
                    return {
                        success: false,
                        error: result.extras?.result_codes?.operations?.join(', ') || result.detail || 'Transaction failed'
                    };
                }

            } catch (error) {
                console.error('Network submission failed:', error);
                return { success: false, error: error.message };
            }
        }

        async function logTransactionToBackend(txHash) {
            try {
                // Get current transaction data
                const transactionData = window.currentTransactionData;
                if (!transactionData) {
                    console.warn('No transaction data found for logging');
                    return;
                }

                // Get user's telegram_id
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();
                const telegram_id = authData.authenticator_info.user.telegram_id;

                // Log to backend
                const response = await fetch('/mini-app/log-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_id: telegram_id,
                        xdr: transactionData.xdr,
                        amount: transactionData.transaction.amount,
                        asset: transactionData.transaction.asset,
                        recipient: transactionData.transaction.recipient,
                        tx_hash: txHash
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Transaction logged to backend');
                } else {
                    console.warn('‚ö†Ô∏è Failed to log transaction to backend');
                }

            } catch (error) {
                console.error('‚ùå Error logging transaction:', error);
            }
        }

        function showTransactionSuccess(hash) {
            document.getElementById('content').innerHTML = `
                <div class="fade-in">
                    <div class="success-message">
                        <div class="success-icon">‚úÖ</div>
                        <h1>Transaction Successful!</h1>
                        <p>Your payment has been sent successfully.</p>
                        <div class="transaction-hash">
                            <strong>Transaction Hash:</strong><br>
                            <code>${hash}</code>
                        </div>
                        <div class="form-actions" style="margin-top: 20px;">
                            <button onclick="showWallet()" class="btn-primary">üè† Back to Wallet</button>
                            <button onclick="window.open('https://stellar.expert/explorer/public/tx/${hash}', '_blank')" class="btn-secondary">üîç View on Explorer</button>
                        </div>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item" onclick="showWallet()">
                        <div class="nav-icon">üíº</div>
                        <div class="nav-label">Wallet</div>
                    </div>
                    <div class="nav-item" onclick="showAuth()">
                        <div class="nav-icon">‚öôÔ∏è</div>
                        <div class="nav-label">Settings</div>
                    </div>
                </nav>
            `;
        }

        function showAssetManagement() {
            // TODO: Implement asset management interface
            alert('Asset Management feature coming soon!');
        }

        function showTransactionHistory() {
            // TODO: Implement transaction history interface
            alert('Transaction History feature coming soon!');
        }

        function testTurnkeyStamper() {
            // Navigate to the test page within the mini app
            window.location.href = '/test-turnkey-stamper';
        }

        // Simple client-side XDR building
        async function buildTransactionXDR(transactionData) {
            try {
                console.log('üîç Building XDR client-side...');
                console.log('Transaction data:', transactionData);
                
                // Get user's public key from the wallet
                const authResponse = await fetch('/mini-app/authenticator');
                const authData = await authResponse.json();
                const sourcePublicKey = authData.authenticator_info.user.public_key;
                
                console.log('Source public key:', sourcePublicKey);
                
                // For now, use a simple XDR template for testing
                // This will be replaced with proper Stellar SDK later
                const xdrTemplate = 'AAAAAgAAAAB' + 
                    btoa(sourcePublicKey).replace(/=/g, '') + // Source account
                    'AAAAAA' + // Sequence number (will be filled by network)
                    'AAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB' + // Time bounds
                    'AAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB' + // Memo
                    'AAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB' + // Operations
                    'AAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB'; // Ext
                
                console.log('‚úÖ Simple XDR template created');
                return xdrTemplate;
                
            } catch (error) {
                console.error('‚ùå Error building XDR:', error);
                throw error;
            }
        }

        // Proper signed XDR construction
        function constructSignedXdr(originalXdr, signature, publicKey) {
            try {
                console.log('üîç Constructing signed XDR...');
                console.log('Original XDR:', originalXdr);
                console.log('Signature:', signature);
                console.log('Public Key:', publicKey);
                
                // For now, return the original XDR since we need to properly construct it
                // The signature is already embedded in the XDR from the TelegramCloudStorageStamper
                // This is a temporary fix - we'll implement proper XDR construction later
                console.log('‚úÖ Using original XDR (signature should be embedded)');
                return originalXdr;
                
            } catch (error) {
                console.error('‚ùå Error constructing signed XDR:', error);
                return originalXdr;
            }
        }
    </script>
</body>

</html>
