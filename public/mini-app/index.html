<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LumenBro Mini App</title>
    <link rel="stylesheet" href="/mini-app/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/turnkey.js?v=2"></script> <!-- Updated to esbuild output with cache busting -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body>
    <div id="content">
        <h1>Welcome to LumenBro Trading Bot</h1>
        <button onclick="window.register()">Register</button>
        <button onclick="window.login()">Login</button>
        <button onclick="window.recover()">Recover</button>
    </div>
    <script src="/recovery-credentials.js"></script>
    <script src="/mini-app/encryption-utils.js"></script>
    <script src="/mini-app/recovery-key-generator.js"></script>
    <script src="/mini-app/export-utils.js"></script>
    <script src="/mini-app/auth.js"></script>
    <script src="/mini-app/login.js"></script>
    <script src="/mini-app/recovery.js"></script>
    <script src="/mini-app/clear.js"></script>  <!-- New script for clear -->
    <script src="/mini-app/mobile-debug.js"></script>  <!-- Mobile debugging -->
    <script src="/mini-app/mobile-encryption-fix.js"></script>  <!-- Mobile encryption fixes -->
    <style>
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
    <script>
        window.addEventListener('load', function () {  // Wait for all resources (including bundle)
            console.log('All loaded â€“ checking Turnkey...');
            if (!window.Turnkey) {
                console.error('Turnkey global not set after load. Check bundle content for errors.');
            } else {
                console.log('Turnkey ready:', window.Turnkey);
            }
            const telegramApp = window.Telegram.WebApp;
            window.params = new URLSearchParams(window.location.search);
            window.orgId = window.params.get('orgId') || 'global-org-id';  // Set global orgId from query param
            window.email = window.params.get('email') || '';  // Set global email from query param
            const action = window.params.get('action');
            if (action === 'register') {
                window.register();
            } else if (action === 'login') {
                window.login();
            } else if (action === 'recover') {
                window.recover();
            } else if (action === 'export') {
                window.showExportForm();
            } else if (action === 'auto-clear') {
                window.autoClearCloudStorage();
            }

            // Debug function and button (made global)
            window.checkCloudStorage = async function() {
                return new Promise((resolve, reject) => {
                    Telegram.WebApp.CloudStorage.getItem('TURNKEY_API_KEY', (error, value) => {
                        if (error) {
                            console.error('Cloud storage error:', error);
                            reject(error);
                        } else {
                            console.log('Stored TURNKEY_API_KEY:', value ? JSON.parse(value) : 'No key stored');
                            resolve(value ? JSON.parse(value) : null);
                        }
                    });
                });
            }

            // Add buttons to trigger debug and clear
            document.getElementById('content').innerHTML += '<button onclick="window.checkCloudStorage()">Check Cloud Storage</button>';
            document.getElementById('content').innerHTML += '<button onclick="window.unregister()">Unregister (Clear)</button>';
        });
    </script>
</body>

</html>
